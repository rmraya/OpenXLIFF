plugins {
    id 'java'
}

// Set Java version
java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
    modularity.inferModulePath = true
}

// Source sets configuration
sourceSets {
    main {
        java {
            srcDirs = ['src']
        }
        resources {
            srcDirs = ['src']
            exclude '**/*.java'
        }
    }
}

// Use existing JAR files from lib folder
dependencies {
    implementation files('lib/bcp47j.jar')
    implementation files('lib/json.jar')
    implementation files('lib/jsoup.jar')
    implementation files('lib/xmljava.jar')
}

// Configure JAR task
jar {
    archiveFileName = 'openxliff.jar'
    destinationDirectory = file('lib')
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Task to create jlink image
task jlinkImage(type: Exec) {
    description = 'Create modular runtime image with jlink'
    group = 'distribution'
    dependsOn jar
    
    doFirst {
        // Clean dist directory first
        delete 'dist'
    }
    
    commandLine 'jlink',
        '--module-path', 'lib:' + System.getProperty('java.home') + '/jmods',
        '--add-modules', 'openxliff',
        '--output', 'dist',
        '--no-man-pages',
        '--no-header-files'
    
    doLast {
        // Remove jrt-fs.jar
        delete file('dist/lib/jrt-fs.jar')
    }
}

// Task to copy batch files (Windows)
task copyBats {
    description = 'Copy .cmd files to /dist'
    group = 'distribution'
    
    doLast {
        if (System.getProperty('os.name').toLowerCase().contains('windows')) {
            copy {
                from projectDir
                into 'dist'
                include '*.cmd'
            }
        }
    }
}

// Task to copy shell scripts (Unix/Linux/macOS)
task copyShells {
    description = 'Copy .sh files to /dist'
    group = 'distribution'
    
    doLast {
        if (!System.getProperty('os.name').toLowerCase().contains('windows')) {
            copy {
                from projectDir
                into 'dist'
                include '*.sh'
            }
            
            // Make shell scripts executable
            fileTree('dist').matching { include '**/*.sh' }.each { file ->
                file.setExecutable(true, false)
            }
        }
    }
}

// Task to copy licenses
task copyLicenses {
    description = 'Copy license info to /dist/'
    group = 'distribution'
    
    doLast {
        copy {
            from 'licenses'
            into 'dist/licenses'
        }
    }
}

// Task to copy additional resources
task copyResources {
    description = 'Copy additional resources to /dist/'
    group = 'distribution'
    
    doLast {
        copy {
            from 'catalog'
            into 'dist/catalog'
        }
        
        copy {
            from 'srx'
            into 'dist/srx'
        }
        
        copy {
            from 'xmlfilter'
            into 'dist/xmlfilter'
        }
        
        copy {
            from 'LICENSE'
            into 'dist'
        }
    }
}

// Main distribution task
task dist {
    description = 'Prepare distribution'
    group = 'distribution'
    
    dependsOn jlinkImage, copyBats, copyShells, copyLicenses, copyResources
    
    // Ensure jlink runs before other copy tasks
    copyBats.mustRunAfter jlinkImage
    copyShells.mustRunAfter jlinkImage
    copyLicenses.mustRunAfter jlinkImage
    copyResources.mustRunAfter jlinkImage
}

// Clean task to remove dist directory
task distclean {
    description = 'Remove dist directory'
    group = 'distribution'
    
    doLast {
        delete 'dist'
    }
}

// Make dist the default task
defaultTasks 'dist'

// Configure clean task to also remove lib/openxliff.jar
clean {
    delete 'lib/openxliff.jar'
}

// Ensure proper build order
compileJava.dependsOn clean
jar.dependsOn compileJava
jlinkImage.dependsOn jar

// Configure compiler options
compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += [
        '--module-path', classpath.asPath
    ]
}
